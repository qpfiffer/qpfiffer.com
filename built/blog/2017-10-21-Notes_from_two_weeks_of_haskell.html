<!DOCTYPE html>
<!--
  ____ ____  _____ ____  _   _ _   _ _   _ _  _______ _
 / ___|  _ \| ____/ ___|| | | | | | | \ | | |/ / ____| |
| |  _| |_) |  _| \___ \| |_| | | | |  \| | ' /|  _| | |
| |_| |  _ <| |___ ___) |  _  | |_| | |\  | . \| |___| |___
 \____|_| \_\_____|____/|_| |_|\___/|_| \_|_|\_\_____|_____|

Proudly generated with GRESHUNKEL, a static site generator for the dead inside.
-->
<html>
    <head>
<title>q.pfiffer.org - <h1>SOMETHINGWENTWRONG</h1></title>        <meta charset="UTF-8">
        <meta name=viewport content="width=device-width, initial-scale=1">
        <meta name="description" content="Technical blog and propoganda for OlegDB">


        <link href='https://fonts.googleapis.com/css?family=Lato' rel='stylesheet' type='text/css'>
        <link rel="stylesheet" media="all" href="/static/css/simplegrid.css" />
        <link rel="stylesheet" media="all" href="/static/css/default.css" />
        <link rel="stylesheet" href="/static/css/blog.css" />
<link rel="stylesheet" href="/static/css/prism.css"/>


        <link rel="stylesheet" media="(max-width: 800px)" href="/static/css/mobile.css" />
    </head>
    <body>
        <header>
            <h2 id="blog_title"><a href="/">Malevolent Cartography</a></h2>
        </header>
        <div id="main_container">
            <div class="blog_container">
<div class="grid grid-pad"><div class="col-1-1"><div class="language-bash content"><h2 class="post_title"> Notes from Two Weeks of Haskell</h2><p><span class="author_name">2017-10-21 by  Quinlan Pfiffer</span><span class="comment_count"><a href="/blog/2017-10-21-Notes_from_two_weeks_of_haskell.html#disqus_thread">Comments</a></span></p><p>I've been writing Haskell at <code>$WORK</code> for about two weeks now, and it's been
pretty fun. I've also learned quite a bit. This is just a place to store some
common idioms/things I've learned, and mostly to have a place where I can put
some simple, explicit code samples.
<h2>PostgreSQL.Simple</h2></p><p><a href=https://hackage.haskell.org/package/postgresql-simple>PostgreSQL.Simple</a> is a great package started by Bryan O'Sullivan,
the guy that primarily wrote <a href=http://book.realworldhaskell.org/read/>Real World Haskell</a>. He also wrote the <a href=http://hackage.haskell.org/package/aeson>Aeson</a>
library. They have similarities, and it's pretty obvious.</p><p>This section is mostly because I keep forgetting (ie. haven't practiced enough)
how to put things into queries, get things out of the database, serialize them
to records, that sort of thing.
<h3>Updating a Record</h3></p><p>Use <code>execute</code> for things that will modify database structures, like <code>UPDATE</code> or
<code>INSERT</code>. You'll notice that here we don't have to specify the types on <code>(name,
lat, lng, session_id)</code> because they exist in the function declaration and GHC
can infer them.</p><p><pre class="language-
"><code>update_location_query = "UPDATE location AS loc \
    \SET name = ?, lat = ?, lng = ? \
    \FROM session AS sesh \
    \WHERE sesh.location_id = loc.id AND \
    \      sesh.id = ?;"</p><p>updateLocation :: T.Text -> T.Text -> Double -> Double -> ReaderT Connection IO Int64
updateLocation session_id name lat lng = do
    conn <- ask
    lift $ execute conn update_location_query (name, lat, lng, session_id)
</code></pre>
<h3>Selecting a Bunch of Records</h3></p><p>We use <code>query_</code> here because <code>query_</code> doesn't expect any arguments to
interpolate into the SQL query.</p><p><pre class="language-
"><code>class_query = "SELECT id, name \
    \FROM class \
    \ORDER BY name;"</p><p>getClasses :: Connection -> IO [Class]
getClasses conn = query_ conn class_query
</code></pre>
<h3>Selecting Just One Record</h3></p><p>This will return a list of one item, but Haskell doesn't know that so it comes
back as a list. It works well enough. This also interpolates the class ID into
the query.</p><p><pre class="language-
"><code>session_query = "SELECT id, timestamp \
    \FROM session \
    \WHERE cls_id = ? \
    \ORDER BY timestamp DESC \
    \LIMIT 1;"</p><p>getSessionsOfClass :: Connection -> Class -> IO [Session]
getSessionsOfClass conn cls =
    query conn session_query class_id
  where class_id = (Only $ classId cls) :: Only UUID
</code></pre>
<h2>ReaderT</h2></p><p><a href=https://hackage.haskell.org/package/transformers-0.5.5.0/docs/Control-Monad-Trans-Reader.html#t:ReaderT>ReaderT</a> is
really useful, and a great introduction (for me) on how to use a monad
transformer stack. I puzzled out a trivial example of using it with
<code>PostgreSQL.Simple</code> to pass database connections around.</p><p>These code samples are what I'm actually using. Here a <code>Connection</code> record is
embedded inside the <code>ReaderT</code> context so we can use it later on, without
explicitly passing around a <code>Connection</code> object. This doesn't have much benefit
now, but later on if we need to add extra functionality it will be trivial to
rewrite the sections of code using the <code>ReaderT</code>, rather than explicitly
redefining each and every type signature of each function that uses the
<code>Connection</code>.</p><p><pre class="language-
"><code>main :: IO ()
main = do
    conn <- connectToDev
    args <- getArgs
    case parseArgs args of
        Just (session_id, address) ->
            flip runReaderT conn $ do
                 startGeocode (T.pack session_id) (T.pack address)
        ...
</code></pre></p><p>and an example of unwrapping the context of the <code>ReaderT</code>:</p><p><pre class="language-
"><code>updateLocation :: T.Text -> T.Text -> Double -> Double -> ReaderT Connection IO Int64
updateLocation session_id name lat lng = do
    conn <- ask
    lift $ execute conn update_location_query (name, lat, lng, session_id)
</code></pre></p><p>Here you can see that we're getting the <code>Connection</code> out of the <code>ReaderT</code> by
<code>ask</code>ing for it. Neat! Also of note here, is that you have to <code>lift</code> the result
of the <code>execute</code> call back into the monad transformer stack. Fun fact here:
Because our transformer stack is only one level deep, you can use <code>lift</code> and
<code>liftIO</code> interchangably.</p><p></p></div><div id="disqus_thread"></div><script type="text/javascript">var disqus_shortname = 'olegdbblog';(function() {var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);})();</script><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript><a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a></div></div></div>


        </div>
        <div id="busted_pixel">
            <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABAQMAAAAl21bKAAAAA1BMVEUA/wA0XsCoAAAACklEQVR4nGNiAAAABgADNjd8qAAAAABJRU5ErkJggg==">
        </div>
            <script type="text/javascript">
    var disqus_shortname = 'olegdbblog';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
    </script>


        <footer>
            <div class="grid grid-pad">
                <div class="col-1-2">
                    <div class="content">
                        <ul>
                            <li>&copy; Copyright 2014-2020, <a href="http://qpfiffer.com/">Quinlan Pfiffer</a></li>
                        </ul>
                    </div>
                </div>
                <div class="col-1-2">
                    <div class="pull-right content">
                        <ul>
                            <!-- <li><a href="http://www.redbubble.com/people/qpfiffer/works/11380090-olegdb-graphics">Merch</a></li> -->
                            <!-- <li><a href="/credits.html">Credits</a></li> -->
                            <li><a href="mailto:qpfiffer@gmail.com">Email</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </footer>
        <script type="text/javascript">
          var _gaq = _gaq || [];
          _gaq.push(['_setAccount', 'UA-30510579-1']);
          _gaq.push(['_trackPageview']);
          (function() {
            var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
          })();
        </script>
    <script type="text/javascript" src="/static/js/prism.js"></script>


    </body>
</html>
