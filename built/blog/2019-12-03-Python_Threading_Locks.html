<!DOCTYPE html>
<!--
  ____ ____  _____ ____  _   _ _   _ _   _ _  _______ _
 / ___|  _ \| ____/ ___|| | | | | | | \ | | |/ / ____| |
| |  _| |_) |  _| \___ \| |_| | | | |  \| | ' /|  _| | |
| |_| |  _ <| |___ ___) |  _  | |_| | |\  | . \| |___| |___
 \____|_| \_\_____|____/|_| |_|\___/|_| \_|_|\_\_____|_____|

Proudly generated with GRESHUNKEL, a static site generator for the dead inside.
-->
<html>
    <head>
<title>q.pfiffer.org - <h1>SOMETHINGWENTWRONG</h1></title>        <meta charset="UTF-8">
        <meta name=viewport content="width=device-width, initial-scale=1">
        <meta name="description" content="Technical blog and propoganda for OlegDB">


        <link href='https://fonts.googleapis.com/css?family=Lato' rel='stylesheet' type='text/css'>
        <link rel="stylesheet" media="all" href="/static/css/simplegrid.css" />
        <link rel="stylesheet" media="all" href="/static/css/default.css" />
        <link rel="stylesheet" href="/static/css/blog.css" />
<link rel="stylesheet" href="/static/css/prism.css"/>


        <link rel="stylesheet" media="(max-width: 800px)" href="/static/css/mobile.css" />
    </head>
    <body>
        <header>
            <h2 id="blog_title"><a href="/">Malevolent Cartography</a></h2>
        </header>
        <div id="main_container">
            <div class="blog_container">
<div class="grid grid-pad"><div class="col-1-1"><div class="language-bash content"><h2 class="post_title"> Python 2 Threading Primitives, Locks and Events</h2><p><span class="author_name">2019-12-03 by  Quinlan Pfiffer</span><span class="comment_count"><a href="/blog/2019-12-03-Python_Threading_Locks.html#disqus_thread">Comments</a></span></p><p>Recently I've had to deal with some inter-process communication in Python 2.7, in
which I had several threads sharing data. I figured doing a brain-dump of some
of this data would be useful for me in the future as well as anyone else
wandering by.</p><p>In this specific instance, I'm retrieving frames from a camera of some sort,
pulling them in over a websocket, then passing them on to an OpenCV processor.
Nothing crazy, but the websocket server couldn't be blocked by the OpenCV
processor, so threads were introduced. Really just two.</p><p>The primary things we care about here are <a href=https://docs.python.org/2/library/threading.html#event-objects>thread events</a> and <a href=https://docs.python.org/2/library/thread.html#thread.allocate_lock>thread
locks.</a>. I wrote this when I was dealing with Python 2, but I don't see why
you couldn't do this stuff in 3+. In general, use <code>asyncio</code> in favor of threads
and locks and processes and whatever. Easier to think about.</p><p>Heres something similar to what I ended up writing:</p><p><pre class="language-
"><code>import thread, threading</p><p>class Server:
    def <strong>init</strong>(self, lock, event):
        self.lock = lock
        self.event = event</p><p># Assume this server is doing a bunch of server-y things, and this
    # method is the callback triggered when new data comes in:
    def msg_received(self, client, server, msg):
        with self.frame_lock:
            self.frame = msg
            self.event.set()</p><p>def get_frame(self):
        return self.frame</p><p>class Processor:
    def <strong>init</strong>(self, lock, event):
        self.lock = lock
        self.event = event</p><p>def process(self, server):
        while self.event.wait():
            with self.lock:
                frame = server.get_frame()
                self.event.clear()</p><p># Do fancy processing here
                ...</p><p>def main():
    frame_lock = thread.allocate_lock()
    frame_event = threading.Event()</p><p># Server receives frames from upstream:
    server = Server(frame_lock, frame_event, ip='localhost', port=8999)</p><p># Processor does fancy computation on frames:
    processor = Processor(frame_lock, frame_event)
    t = Threading.Thread(target=processor.process, args=(server,))
    t.start()</p><p>server.run_forever()</p><p>if <strong>name</strong> == '<strong>main</strong>':
    main()
</code></pre></p><p>This is more or less what I have. I haven't tested the above code, but the point
is you have a Server of some sort operating independently of a processor of
some other sort. Later on I might write another post detailing how you might do this
with a <a href=http://man7.org/linux/man-pages/man2/pipe.2.html>UNIX pipe</a> instead of
this Locking/Event style, but we can talk about that when the time comes. Or
doesn't. Whatever.</p><p>The fancy (but still basic) thing here is the event, and the lock. You can use
the event to avoid spinlocking (eg. <code>while not frame: ...</code>), and instead only
wake up your expensive processing Thread when it has something to do. Remember,
<code>sleep()</code> is a sign that you're being lazy!</p><p>One thread will call <code>event.set()</code> when it is done operating on the shared
resource, then back off. The next thread will then wake up and wait to acquire
the lock, so it can operate on the shared resource, doing it's thing, and then
calling <code>event.clear()</code>. This ends up working really nicely because each thread
only works when it can, no one is stepping on anyone elses toes and it all just
works out.</p><p></p></div><div id="disqus_thread"></div><script type="text/javascript">var disqus_shortname = 'olegdbblog';(function() {var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);})();</script><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript><a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a></div></div></div>


        </div>
        <div id="busted_pixel">
            <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABAQMAAAAl21bKAAAAA1BMVEUA/wA0XsCoAAAACklEQVR4nGNiAAAABgADNjd8qAAAAABJRU5ErkJggg==">
        </div>
            <script type="text/javascript">
    var disqus_shortname = 'olegdbblog';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
    </script>


        <footer>
            <div class="grid grid-pad">
                <div class="col-1-2">
                    <div class="content">
                        <ul>
                            <li>&copy; Copyright 2014-2020, <a href="http://qpfiffer.com/">Quinlan Pfiffer</a></li>
                        </ul>
                    </div>
                </div>
                <div class="col-1-2">
                    <div class="pull-right content">
                        <ul>
                            <!-- <li><a href="http://www.redbubble.com/people/qpfiffer/works/11380090-olegdb-graphics">Merch</a></li> -->
                            <!-- <li><a href="/credits.html">Credits</a></li> -->
                            <li><a href="mailto:qpfiffer@gmail.com">Email</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </footer>
        <script type="text/javascript">
          var _gaq = _gaq || [];
          _gaq.push(['_setAccount', 'UA-30510579-1']);
          _gaq.push(['_trackPageview']);
          (function() {
            var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
          })();
        </script>
    <script type="text/javascript" src="/static/js/prism.js"></script>


    </body>
</html>
